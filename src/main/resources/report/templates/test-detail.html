<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ME2E Test Results</title>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.5.0/css/all.css">
    <link rel="stylesheet" href="../tree-table/jquery.treetable.css">
    <link rel="stylesheet" href="../css/report-style.css">
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="../tree-table/jquery.treetable.js"></script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        .tag {
            padding: 3px 5px;
            border-radius: 8px;
            border: 2px solid #4541DD;
            font-size: 14px;
            font-weight: 600;
            color: #4541DD;
            background-color: #f7f7ff;
        }

        .container-chip {
            & input {
                appearance: none;
                -webkit-appearance: none;
                -moz-appearance: none;
                margin: 0;
            }

            & input:checked + .label {
                border-color: #4541DD;
                background-color: #4541DD;
                color: white;
                box-shadow: -5px 10px 20px 0 rgba(69, 65, 221, 0.25);
            }

            & .label {
                border-radius: 100px;
                background-color: #fff;
                border: 1px solid #b5b5b5;
                padding: 5px 10px;
                cursor: pointer;
            }
        }

        table {
            & .label {
                font-weight: 600;
                width: 80px;
            }

            & td {
                padding: 5px 0;
            }
        }

        .metadata-table td {
            vertical-align: top;
        }

        .children-table {
            & thead {
                border-bottom: solid #A6A6A6 1px;

                & th {
                    text-align: start;
                    padding: 5px 30px 5px 0;
                }

                & th:nth-child(2),
                & th:nth-child(3),
                & th:nth-child(4) {
                    text-align: center;
                }

                & th:nth-child(5) {
                    padding: 5px 0;
                }
            }

            & tbody {
                & td {
                    padding: 5px 30px 5px 0;
                }

                & td:nth-child(2),
                & td:nth-child(3),
                & td:nth-child(4) {
                    text-align: center;
                }

                & td:nth-child(5) {
                    padding: 5px 0;
                }
            }
        }

        .log-table {
            table-layout: fixed;

            > thead {
                position: sticky;
                box-shadow: 0 1px 0 0 #A6A6A6;
                background-color: #FBFBFB;

                > tr > th > input[type="search"] {
                    margin-left: 12px;
                }
            }

            & th {
                text-align: start;
                padding: 10px 0;
            }

            & td {
                padding: 3px 0;
                vertical-align: top;
            }

            & th:first-child {
                width: 95px;
            }

            & th:nth-child(2) {
                width: 140px;
            }

            & td:first-child {
                width: 97px;
            }

            & td:nth-child(2) {
                width: 142px;
            }

            & tbody {
                display: block;
                overflow-y: auto;
                max-height: 400px;
            }

            & tr {
                display: table;
                width: 100%;
            }

            & .filter-modal label {
                font-family: monospace;
                font-size: 16px;
            }
        }

        .stack-trace {
            background-color: rgba(255, 95, 86, 0.05);
            border: 2px solid #FF5F56;
            margin-top: 3px;
        }

        h4 {
            background-color: rgba(129, 169, 231, 0.1);
            color: #618bde;
            padding: 5px 0;
        }

        .traces-table-container {
            overflow-x: auto;
        }

        .traces-table {
            border-collapse: collapse;
            table-layout: fixed;
            width: unset;

            & td {
                padding: 0 10px 0 0;
                vertical-align: top;
            }

            & .status {
                border-radius: 64px;
                padding: 2px 8px;
                color: white;
                font-weight: bolder;
                margin-right: 6px;
            }

            > thead > tr > th:first-child,
            > tbody > tr > td:first-child {
                position: sticky;
                left: 0;
                z-index: 2;
                background-color: white;
                min-width: 200px;
                box-shadow: inset -1px 0 0 0 #A6A6A6;
                text-align: start;
                white-space: nowrap;
            }

            > tbody > tr > td:first-child > .overflow {
                display: inline-block;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 400px;
                vertical-align: text-bottom;

                &:hover {
                    overflow: visible;
                }

                &:hover span {
                    background-color: white;
                }
            }

            > tbody > tr:first-child > td:first-child,
            > tbody > tr:first-child > td > .gantt-row > .gantt-item {
                padding-top: 12px;
            }
        }

        .gantt-row {
            display: grid;
            grid-template-columns: 50px repeat(auto-fit, 150px);
            grid-auto-flow: column;
            grid-auto-columns: 150px;
            grid-gap: 1px;
            background-color: #efefef;

            > .time-series {
                position: relative;
                left: -75px;
                text-align: center;
                font-size: 12px;
                background-color: white;
            }

            > .gantt-item {
                background-color: white;

                > details {
                    position: relative;
                    width: 500px;

                    > summary {
                        list-style: none;
                    }

                    > summary::-webkit-details-marker {
                        display: none;
                    }
                }
            }

            & .gantt-bar {
                display: block;
                height: 12px;
                position: relative;
                border-radius: 12px;
                cursor: pointer;
                margin-top: 5px;
                margin-bottom: 2px;
            }

            & .duration {
                font-size: 12px;
                color: grey;
                display: flex;
                justify-content: end;
            }
        }

        .trace-details {
            background-color: white;
            border: 1pt solid #cbcbcb;
            border-radius: 4px;
            padding: 4px;
            box-shadow: 0 0 10px 0 rgba(0, 0, 0, 0.05);

            & .header {
                background-color: aliceblue;
                padding: 2px 0;
                margin-bottom: 6px;
            }
        }

        .trace-details-table {
            & .label {
                font-weight: 600;
                width: 105px;
            }

            & td {
                padding: 3px 0;
            }

            & .http-payload {
                font-size: 15px;
                white-space: pre-wrap;
            }
        }
    </style>
</head>
<body>
<div style="display: flex; justify-content: space-between; align-items: center;">
    <h1>Test Summary: [[${displayName}]]</h1>
    <a href="../index.html" style="color: #15134C; text-decoration: none;">
        <i class="fas fa-home fa-lg"></i>
    </a>
</div>
<div style="color: #A6A6A6; margin-bottom: 24px;">
    Source: [[${source}]]
</div>

<div class="card" style="padding: 24px">
    <table class="tree-table test-overview-table" id="test-overview">
        <thead>
        <tr>
            <th class="align-left">Test</th>
            <th>Tests</th>
            <th>Failures</th>
            <th>Ignored</th>
            <th>Duration</th>
            <th>Success Rate</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="test : ${allTests}" th:data-tt-id="${test.testId}" th:data-tt-parent-id="${test.parentId}">
            <td class="align-left">
                <a th:classappend="${test.status.name == 'SKIPPED' ? 'skipped' : (test.numberOfFailures > 0 ? 'failure' : (test.numberOfAborted > 0 ? 'aborted' : 'success'))}"
                   th:href="${'../sources/' + test.source + '.html#' + test.testId}"
                >
                    <span th:text="${test.displayName}"></span>
                </a>
            </td>
            <td th:text="${test.numberOfTests}"></td>
            <td th:text="${test.numberOfFailures}"></td>
            <td th:text="${test.numberOfSkipped + test.numberOfAborted}"></td>
            <td th:text="${test.status.name != 'SKIPPED' ? test.duration + 's' : '-'}"></td>
            <td th:classappend="${test.status.name == 'SKIPPED' ? 'skipped' : (test.numberOfFailures > 0 ? 'failure' : (test.numberOfAborted > 0 ? 'aborted' : 'success'))}"
                th:text="${(test.successRate != null && test.status.name != 'ABORTED') ? test.successRate + ' %' : '-'}"
            ></td>
        </tr>
        </tbody>
    </table>
</div>

<h2>Resource Usage</h2>
<div th:if="${!statsByContainer.isEmpty()}">
    <p>
        The following diagrams show the resource usage of the Docker containers during the execution
        of the tests belonging to "[[${displayName}]]".
    </p>
    <div class="card">
        <div>
            Select the container for which you want to display the resource usage.
        </div>
        <div class="container-chip-group" style="padding: 16px 0 48px 0;">
            <span th:each="entry, i : ${statsByContainer}" class="container-chip">
                <label th:for="${entry.key}">
                    <input type="radio" th:id="${entry.key}"
                           th:value="${entry.key}" name="container-chip-group"
                           th:attr="onclick=|onContainerSelected('${entry.key}')|"
                           th:checked="${i.first}">
                    <span th:text="${entry.key}" class="label"></span>
                </label>
            </span>
        </div>
        <div style="text-align: center; margin-bottom: 12px;">
            <b>Resource Usage of Container "<span id="resource-usage-selected-container-name"></span>"</b>
        </div>
        <div style="height: 300px;">
            <div id="resource-usage-chart"></div>
        </div>
    </div>
</div>
<div th:if="${statsByContainer.isEmpty()}">
    <div class="card">
        <div style="height: 200px; display: flex; align-items: center; justify-content: center;">
            <span style="font-size: 20px; margin-right: 12px; color: #A6A6A6;">No Data Available</span>
            <div class="tooltip"><i class="fas fa-circle-info"></i>
                <div class="tooltip-text" style="text-align: start;">
                    There may be several reasons why no data is available:
                    <ul>
                        <li>
                            No containers were started or the started containers were no longer active when this test class was executed.
                        </li>
                        <li>
                            No data was collected during the execution of the tests in this test class. As Docker only sends the data once
                            per second, it is possible that no data was received during the execution.
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<h2>Test Results</h2>
<div th:each="test, iter : ${allTests}" th:id="${test.testId}">
    <h3>
        <span th:switch="${test.status.name}">
            <i th:case="'SKIPPED'" class="fas fa-ban skipped"></i>
            <i th:case="'SUCCESSFUL'" class="fas fa-circle-check success"></i>
            <i th:case="'FAILED'" class="fas fa-circle-xmark failure"></i>
            <i th:case="'ABORTED'" class="fas fa-ban aborted"></i>
        </span>
        <span> </span>
        <span th:each="entry, i : ${test.path}">
            <span th:if="${!i.last}">
                <a style="color: #15134C;" th:href="${'../sources/' + source + '.html#' + entry.first}">[[${entry.second}]]</a>
            </span>
            <span th:if="${i.last}">
                <span th:text="${entry.second}"></span>
            </span>
            <span th:if="${!i.last}"> ></span>
        </span>
    </h3>

    <div class="card">
        <table class="metadata-table">
            <tr th:if="${!test.tags.isEmpty()}">
                <td class="label">Tags:</td>
                <td>
                    <span th:each="tag, i : ${test.tags}">
                        <span class="tag" th:text="${tag}"></span>
                        <span th:if="${!i.last}"> </span>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="label">Status:</td>
                <td th:switch="${test.status.name}">
                    <span th:case="'SKIPPED'" class="skipped"><i class="fas fa-ban"></i> <b>Skipped</b></span>
                    <span th:case="'SUCCESSFUL'" class="success"><i class="fas fa-circle-check"></i> <b>Success</b></span>
                    <span th:case="'FAILED'" class="failure"><i class="fas fa-circle-xmark"></i> <b>Failed</b></span>
                    <span th:case="'ABORTED'" class="aborted"><i class="fas fa-ban"></i> <b>Aborted</b></span>
                </td>
            </tr>
            <tr th:if="${test.status.name == 'SKIPPED' && test.reason != null}">
                <td class="label">Reason:</td>
                <td>
                    <span th:text="${test.reason}"></span>
                </td>
            </tr>
            <tr th:if="${test.status.name != 'SKIPPED'}">
                <td class="label">Started:</td>
                <td th:text="${#temporals.format(test.startTime, 'dd.MM.yyyy HH:mm:ss.SSS')}"></td>
            </tr>
            <tr th:if="${test.status.name != 'SKIPPED'}">
                <td class="label">Finished:</td>
                <td th:text="${#temporals.format(test.endTime, 'dd.MM.yyyy HH:mm:ss.SSS')}"></td>
            </tr>
            <tr th:if="${test.status.name != 'SKIPPED'}">
                <td class="label">Duration:</td>
                <td th:text="${test.duration} + 's'"></td>
            </tr>
            <tr th:if="${test.status.name != 'SKIPPED' && !test.reportEntries.isEmpty()}">
                <td class="label">Report Entries:</td>
                <td>
                    <ul>
                        <li th:each="entry, i : ${test.reportEntries}" th:style="${!i.first ? 'margin-top: 12px;' : ''}">
                            <b>Entry [[${i.index + 1}]]</b> ([[${#temporals.format(entry.timestamp, 'dd.MM.yyyy HH:mm:ss.SSS')}]]):
                            <ul>
                                <li th:each="mapEntry : ${entry.keyValuePairs}">[[${mapEntry.key}]]: [[${mapEntry.value}]]</li>
                            </ul>
                        </li>
                    </ul>
                </td>
            </tr>
        </table>


        <div th:if="${test.status.name != 'SKIPPED'}">
            <div th:if="${test.stackTrace != null}">
                <div style="margin-top: 12px;">
                    <b>Failure:</b>
                </div>
                <div>
                    <pre th:text="${test.stackTrace}" class="stack-trace"></pre>
                </div>
            </div>

            <hr th:if="${!test.children.isEmpty() || !test.traces.isEmpty() || !test.logs.isEmpty()}" class="divider">
        </div>

        <div th:if="${!test.children.isEmpty()}">
            <h4>Children</h4>
            <table class="children-table">
                <thead>
                <tr>
                    <th>Test</th>
                    <th>Started</th>
                    <th>Finished</th>
                    <th>Duration</th>
                    <th>Status</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="child : ${test.children}">
                    <td>
                        <a th:classappend="${child.status.name == 'SKIPPED' ? 'skipped' : (child.numberOfFailures > 0 ? 'failure' : (child.numberOfAborted > 0 ? 'aborted' : 'success'))}"
                           th:href="${'../sources/' + child.source + '.html#' + child.testId}"
                        >
                            <span th:text="${child.displayName}"></span>
                        </a>
                    </td>
                    <td>
                        <span th:if="${child.status.name != 'SKIPPED'}"
                              th:text="${#temporals.format(child.startTime, 'HH:mm:ss.SSS')}"
                        ></span>
                        <span th:if="${child.status.name == 'SKIPPED'}">-</span>
                    </td>
                    <td>
                        <span th:if="${child.status.name != 'SKIPPED'}"
                              th:text="${#temporals.format(child.endTime, 'HH:mm:ss.SSS')}"
                        ></span>
                        <span th:if="${child.status.name == 'SKIPPED'}">-</span>
                    </td>
                    <td>
                        <span th:if="${child.status.name != 'SKIPPED'}"
                              th:text="${child.duration} + 's'"
                        ></span>
                        <span th:if="${child.status.name == 'SKIPPED'}">-</span>
                    </td>
                    <td th:switch="${child.status.name}">
                        <span th:case="'SKIPPED'" class="skipped"><i class="fas fa-ban"></i> <b>Skipped</b></span>
                        <span th:case="'SUCCESSFUL'" class="success"><i class="fas fa-circle-check"></i> <b>Success</b></span>
                        <span th:case="'FAILED'" class="failure"><i class="fas fa-circle-xmark"></i> <b>Failed</b></span>
                        <span th:case="'ABORTED'" class="aborted"><i class="fas fa-ban"></i> <b>Aborted</b></span>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>


        <div th:if="${test.status.name != 'SKIPPED'}">
            <div th:if="${!test.traces.isEmpty()}">
                <h4>Network Traces</h4>
                <div class="traces-table-container">
                    <table class="traces-table" th:id="${'traces-' + test.testId}"
                           th:with="timeSeries=${tracesTimeSeries.get(test.testId)}">
                        <thead>
                        <tr>
                            <th>Request</th>
                            <th>
                                <div class="gantt-row" style="background-color: white">
                                    <div></div>
                                    <div th:each="timestamp : ${timeSeries}"
                                         th:text="${#temporals.format(timestamp, 'HH:mm:ss.SSS')}" class="time-series">
                                    </div>
                                </div>
                            </th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="trace : ${test.traces}" th:data-tt-id="${trace.id}" th:data-tt-parent-id="${trace.parentId}"
                            th:with="request=${trace.request},response=${trace.response}">
                            <td th:with="status=${response.statusCode}">
                                <span th:text="${status}"
                                      th:styleappend="${'background-color:' + (status <= 199 ? '#1a6bff' : (status <= 299 ? '#0BBD58' : (status <= 399 ? '#1ac0ff' : (status <= 499 ? '#ffb91a' : '#FF5F56'))))}"
                                      class="status"></span>
                                <span class="overflow">
                                    <span th:text="${request.statusLine}" class="inline-code"></span>
                                </span>
                            </td>
                            <td th:with="left=${@java.time.Duration@between(timeSeries[0], request.timestamp).toMillis() * 1.5}">
                                <div class="gantt-row">
                                    <div style="background-color: white;"></div>
                                    <div class="gantt-item"
                                         th:with="width=${@java.time.Duration@between(request.timestamp, response.timestamp).toMillis() * 1.5}">
                                        <details th:style="'left:' + ${left} + 'px'">
                                            <summary th:styleappend="'width:' + ${width} + 'px'" style="display: block;">
                                                <span class="gantt-bar"
                                                      th:styleappend="'background-color:' + ${trace.client != null ? trace.client.color : '#4541DD'}">
                                                </span>
                                                <span th:text="${trace.duration} + 'ms'" class="duration"></span>
                                            </summary>
                                            <div class="trace-details">
                                                <div class="header">
                                                    <b>Request:</b> <span th:text="${request.statusLine}" class="inline-code"></span>
                                                </div>
                                                <table class="trace-details-table">
                                                    <tr>
                                                        <td class="label">Frame-No.:</td>
                                                        <td th:text="${request.number}"></td>
                                                    </tr>
                                                    <tr>
                                                        <td class="label">Timestamp:</td>
                                                        <td th:text="${#temporals.format(request.timestamp, 'dd.MM.yyyy HH:mm:ss.SSS')}"></td>
                                                    </tr>
                                                    <tr>
                                                        <td class="label">Source:</td>
                                                        <td th:with="client=${trace.client}">
                                                            <span th:if="${client != null}">
                                                                <i class="fas fa-square" th:styleappend="'color:' + ${client.color}"
                                                                   style="font-size: 14px; vertical-align: 1px;"></i>
                                                                <span th:if="${client.nodeType.name == 'CONTAINER' || client.nodeType.name == 'TEST_RUNNER'}">
                                                                    <span th:text="${client.name}"></span>
                                                                </span>
                                                                <span th:if="${client.nodeType.name == 'MOCK_SERVER'}">
                                                                    Mock Server <i th:text="${client.name}" class="break-word"></i>
                                                                </span>
                                                                <span th:if="${client.nodeType.name == 'NETWORK_GATEWAY'}">
                                                                    Network Gateway <i th:text="${client.name}" class="break-word"></i>
                                                                </span>
                                                                (<span th:text="${request.sourceIp + ':' + request.sourcePort}"
                                                                       class="inline-code"></span>)
                                                            </span>
                                                            <span th:if="${client == null}">
                                                                <span th:text="${request.sourceIp + ':' + request.sourcePort}"
                                                                      class="inline-code"></span>
                                                            </span>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="label">Destination:</td>
                                                        <td th:with="server=${trace.server}">
                                                            <span th:if="${server != null}">
                                                                <i class="fas fa-square" th:styleappend="'color:' + ${server.color}"
                                                                   style="font-size: 14px; vertical-align: 1px;"></i>
                                                                <span th:if="${server.nodeType.name == 'CONTAINER' || server.nodeType.name == 'TEST_RUNNER'}">
                                                                    <span th:text="${server.name}"></span>
                                                                </span>
                                                                <span th:if="${server.nodeType.name == 'MOCK_SERVER'}">
                                                                    Mock Server <i th:text="${server.name}" class="break-word"></i>
                                                                </span>
                                                                <span th:if="${server.nodeType.name == 'NETWORK_GATEWAY'}">
                                                                    Network Gateway <i th:text="${server.name}" class="break-word"></i>
                                                                </span>
                                                                (<span th:text="${request.destinationIp + ':' + request.destinationPort}"
                                                                       class="inline-code"></span>)
                                                            </span>
                                                            <span th:if="${server == null}">
                                                                <span th:text="${request.destinationIp + ':' + request.destinationPort}"
                                                                      class="inline-code"></span>
                                                            </span>
                                                        </td>
                                                    </tr>
                                                    <tr th:if="${!request.headers.isEmpty()}">
                                                        <td class="label">Headers:</td>
                                                        <td class="inline-code break-word">
                                                            <div th:each="entry : ${request.headers}">
                                                                <b th:text="${entry.key} + ':'"></b>
                                                                <span th:text="${entry.value}"></span>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    <tr th:if="${request.payload != null}">
                                                        <td class="label">Payload:</td>
                                                        <td>
                                                            <pre th:text="${request.payload}" class="http-payload break-word"
                                                                 style="margin: 0;"></pre>
                                                        </td>
                                                    </tr>
                                                </table>

                                                <div class="header" style="margin-top: 12px;">
                                                    <b>Response:</b> <span th:text="${response.statusLine}" class="inline-code"></span>
                                                </div>
                                                <table class="trace-details-table">
                                                    <tr>
                                                        <td class="label">Frame-No.:</td>
                                                        <td th:text="${response.number}"></td>
                                                    </tr>
                                                    <tr>
                                                        <td class="label">Timestamp:</td>
                                                        <td th:text="${#temporals.format(response.timestamp, 'dd.MM.yyyy HH:mm:ss.SSS')}"></td>
                                                    </tr>
                                                    <tr>
                                                        <td class="label">Source:</td>
                                                        <td th:with="server=${trace.server}">
                                                            <span th:if="${server != null}">
                                                                <i class="fas fa-square" th:styleappend="'color:' + ${server.color}"
                                                                   style="font-size: 14px; vertical-align: 1px;"></i>
                                                                <span th:if="${server.nodeType.name == 'CONTAINER' || server.nodeType.name == 'TEST_RUNNER'}">
                                                                    <span th:text="${server.name}"></span>
                                                                </span>
                                                                <span th:if="${server.nodeType.name == 'MOCK_SERVER'}">
                                                                    Mock Server <i th:text="${server.name}" class="break-word"></i>
                                                                </span>
                                                                <span th:if="${server.nodeType.name == 'NETWORK_GATEWAY'}">
                                                                    Network Gateway <i th:text="${server.name}" class="break-word"></i>
                                                                </span>
                                                                (<span th:text="${response.sourceIp + ':' + response.sourcePort}"
                                                                       class="inline-code"></span>)
                                                            </span>
                                                            <span th:if="${server == null}">
                                                                <span th:text="${response.sourceIp + ':' + response.sourcePort}"
                                                                      class="inline-code"></span>
                                                            </span>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="label">Destination:</td>
                                                        <td th:with="client=${trace.client}">
                                                            <span th:if="${client != null}">
                                                                <i class="fas fa-square" th:styleappend="'color:' + ${client.color}"
                                                                   style="font-size: 14px; vertical-align: 1px;"></i>
                                                                <span th:if="${client.nodeType.name == 'CONTAINER' || client.nodeType.name == 'TEST_RUNNER'}">
                                                                    <span th:text="${client.name}"></span>
                                                                </span>
                                                                <span th:if="${client.nodeType.name == 'MOCK_SERVER'}">
                                                                    Mock Server <i th:text="${client.name}" class="break-word"></i>
                                                                </span>
                                                                <span th:if="${client.nodeType.name == 'NETWORK_GATEWAY'}">
                                                                    Network Gateway <i th:text="${client.name}" class="break-word"></i>
                                                                </span>
                                                                (<span th:text="${response.destinationIp + ':' + response.destinationPort}"
                                                                       class="inline-code"></span>)
                                                            </span>
                                                            <span th:if="${client == null}">
                                                                <span th:text="${response.destinationIp + ':' + response.destinationPort}"
                                                                      class="inline-code"></span>
                                                            </span>
                                                        </td>
                                                    </tr>
                                                    <tr th:if="${!response.headers.isEmpty()}">
                                                        <td class="label">Headers:</td>
                                                        <td class="inline-code break-word">
                                                            <div th:each="entry : ${response.headers}">
                                                                <b th:text="${entry.key} + ':'"></b>
                                                                <span th:text="${entry.value}"></span>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    <tr th:if="${response.payload != null}">
                                                        <td class="label">Payload:</td>
                                                        <td>
                                                            <pre th:text="${response.payload}" class="http-payload break-word"
                                                                 style="margin: 0;"></pre>
                                                        </td>
                                                    </tr>
                                                </table>
                                            </div>
                                        </details>
                                    </div>
                                    <div class="gantt-item" th:each="i : ${#numbers.sequence(1, timeSeries.size() - 1)}"></div>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div th:if="${!test.logs.isEmpty()}">
                <h4>Logs</h4>
                <div style="display: flex; align-items: center; margin-bottom: 12px; position: relative;">
                    <input type="search" th:id="'log-message-search-' + ${test.testId}"
                           th:attr="oninput=|filterLogs('${test.testId}')|" placeholder="Search for messages...">
                    <i class="fas fa-xmark clear-search" th:id="'clear-log-message-search-' + ${test.testId}"
                       th:attr="onclick=|clearSearch('${test.testId}')|"></i>
                </div>

                <table th:id="'log-table-' + ${test.testId}" class="log-table">
                    <thead>
                    <tr>
                        <th>Time</th>
                        <th>
                            Service
                            <div class="filter-modal-container" style="margin-left: 12px;">
                                <i th:id="'log-filter-' + ${test.testId}" class="filter-button fas fa-filter"></i>
                                <div th:id="'log-filter-modal-' + ${test.testId}" class="filter-modal">
                                    <div class="clear-filter">
                                        <div th:attr="onclick=|clearServiceFilter('${test.testId}')|">
                                            <i class="fas fa-xmark"></i>
                                            <span>Clear filter</span>
                                        </div>
                                    </div>
                                    <div th:each="service : ${loggingServices.get(test.testId)}" style="margin-top: 6px;">
                                        <input type="checkbox" th:style="'accent-color:' + ${service.color}"
                                               th:id="'logging-service-' + ${test.testId} + ${service.id}" th:value="${service.name}"
                                               th:name="'log-service-filter-' + ${test.testId}"
                                               th:attr="onclick=|filterLogs('${test.testId}')|">
                                        <label th:text="${service.name}" class="break-word"
                                               th:for="'logging-service-' + ${test.testId} + ${service.id}"></label>
                                    </div>
                                </div>
                            </div>
                        </th>
                        <th>Message</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="entry : ${test.logs}">
                        <td><code th:text="${#temporals.format(entry.timestamp, 'HH:mm:ss.SSS')}"></code></td>
                        <td>
                            <i class="fas fa-square" style="font-size: 11px;" th:styleappend="${'color: ' + entry.service.color}"></i>
                            <code th:text="${entry.service.name}" class="break-word"></code>
                        </td>
                        <td><code th:text="${entry.message}" style="white-space: pre-wrap" class="break-word"></code></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div th:if="${!iter.last}" style="padding: 16px 0;"></div>
</div>

<div id="footer">
    <span>Generated by <a href="https://gitlab.informatik.uni-bremen.de/master-thesis1/me2e">ME2E</a> at [[${generationTimestamp}]]</span>
</div>

<script type="text/javascript" th:inline="javascript">
    const containerResourceStatistics = /*[[${statsByContainer}]]*/ {};
    let selectedContainerStatistics;

    google.charts.load('current', {'packages': ['line']});
    initializeSelectedContainer();
    google.charts.setOnLoadCallback(drawChart);

    /**
     * Initializes variable [selectedContainerStatistics] based on the [containerResourceStatistics].
     * If [containerResourceStatistics] contains at least one entry, the selected container is
     * set to the first container in the map. Otherwise, the chart is not displayed, since the
     * Thymeleaf condition `${!statsByContainer.isEmpty()}` reolves to `false`.
     */
    function initializeSelectedContainer() {
        if (Object.keys(containerResourceStatistics).length === 0) {
            selectedContainerStatistics = null;
        } else {
            onContainerSelected(Object.keys(containerResourceStatistics)[0]);
        }
    }

    /**
     * Updates the chart data by setting its values to the resource statistics of the [containerName].
     * When this method is called for the first time, the google visualizations package may not be
     * loaded completely. Therefore, exceptions which may occur during drawing the chart, are ignored.
     * As soon as the package is loaded, the [onLoadCallback] calls the function again.
     * @param containerName Name of the container which was selected.
     */
    function onContainerSelected(containerName) {
        document.getElementById('resource-usage-selected-container-name').innerHTML = containerName;
        selectedContainerStatistics = containerResourceStatistics[containerName];
        try {
            drawChart();
        } catch (e) {
        }
    }

    /**
     * Draws line chart for the resource usage statistics of the selected container.
     */
    function drawChart() {
        if (selectedContainerStatistics == null) {
            return;
        }

        const data = new google.visualization.DataTable();
        data.addColumn('datetime', 'Time');
        data.addColumn('number', 'Memory Usage');
        data.addColumn('number', 'CPU Usage');
        data.addColumn('number', 'Network IN');
        data.addColumn('number', 'Network OUT');
        for (const entry of selectedContainerStatistics) {
            data.addRow([
                new Date(Date.parse(entry.timestamp)),
                entry.memoryUsage.percentage,
                entry.cpuUsage.percentage,
                entry.networkUsage.received,
                entry.networkUsage.sent
            ]);
        }

        const options = {
            height: 300,
            series: {
                0: {targetAxisIndex: 0, color: '#ffc417'},
                1: {targetAxisIndex: 0, color: '#DE4B40'},
                2: {targetAxisIndex: 1, color: '#4640DE'},
                3: {targetAxisIndex: 1, color: '#40DE81'}
            },
            selectionMode: 'multiple',
            hAxis: {
                format: 'HH:mm:ss',
            },
            vAxes: {
                0: {
                    title: 'Percentage',
                    format: "#.##' %'",
                    viewWindow: {
                        min: 0,
                    },
                },
                1: {
                    title: 'Number of Bytes',
                    viewWindow: {
                        min: 0,
                    },
                },
            },
        };

        const chart = new google.charts.Line(document.getElementById('resource-usage-chart'));
        chart.draw(data, google.charts.Line.convertOptions(options));
    }
</script>

<script type="text/javascript" th:inline="javascript">
    const allTests = /*[[${allTests}]]*/ [];
    const open = new Map();
    const modals = new Map();
    const filterButtons = new Map();

    for (const test of allTests) {
        if (test.status === "SKIPPED" || test.logs.length === 0) {
            continue;
        }
        open.set(test.testId, false);
        let modal = document.getElementById(`log-filter-modal-${test.testId}`);
        let filterButton = document.getElementById(`log-filter-${test.testId}`);
        modals.set(test.testId, modal);
        filterButtons.set(test.testId, filterButton);

        // Toggle modal on click
        filterButton.onclick = function () {
            if (!open.get(test.testId)) {
                modal.style.display = "block";
            } else {
                modal.style.display = "none";
            }

            open.set(test.testId, !open.get(test.testId));
        }
    }

    /**
     * Closes filter modal on click outside.
     * Only keeps one modal open at a time.
     */
    window.onclick = function (event) {
        for (const testId of modals.keys()) {
            let modal = modals.get(testId);
            let filterButton = filterButtons.get(testId);
            if (!modal.contains(event.target) && event.target !== filterButton) {
                modal.style.display = "none";
                open.set(testId, false);
            }
        }
    }

    /**
     * Clears filter for logs by service.
     */
    function clearServiceFilter(testId) {
        const checkboxes = document.getElementsByName(`log-service-filter-${testId}`);
        for (const checkbox of checkboxes) {
            checkbox.checked = false;
        }
        filterLogs(testId);
        modals.get(testId).style.display = "none";
        open.set(testId, false);
    }

    /**
     * Clears search field for log messages.
     */
    function clearSearch(testId) {
        const messageFilterField = document.getElementById(`log-message-search-${testId}`);
        messageFilterField.value = "";
        filterLogs(testId);
    }

    /**
     * Hides all rows in log table which were not logged by the selected services and do not match the search value.
     * Changes style of filter button and search field to highlight whether filters are active.
     */
    function filterLogs(testId) {
        const logTable = document.getElementById(`log-table-${testId}`);
        const rows = logTable.getElementsByTagName("tr");
        const checkboxes = document.getElementsByName(`log-service-filter-${testId}`);
        const selected = [...checkboxes].filter((c) => c.checked).map((c) => c.value);
        const messageFilterField = document.getElementById(`log-message-search-${testId}`);
        const messageFilter = messageFilterField.value.toLowerCase();
        highlightServiceFilter(testId, selected, checkboxes);
        highlightLogMessageSearch(testId, messageFilterField);
        updateLogTableRows(rows, (service, message) =>
            (selected.length === 0 || selected.includes(service)) && (message.toLowerCase().indexOf(messageFilter) > -1)
        );
    }

    /**
     * Hides all rows in log table for which the function `shouldDisplay` returns false.
     */
    function updateLogTableRows(rows, shouldDisplay) {
        for (const row of rows) {
            let data = row.getElementsByTagName("td");
            let serviceCell = data[1];
            let messageCell = data[2];
            if (serviceCell && messageCell) {
                let service = (serviceCell.textContent || serviceCell.innerText).trim();
                let message = messageCell.textContent || messageCell.innerText;
                if (shouldDisplay(service, message)) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            }
        }
    }

    function highlightServiceFilter(testId, selected, checkboxes) {
        if (selected.length === 0 || checkboxes.length === selected.length) {
            filterButtons.get(testId).style.color = "unset";
            filterButtons.get(testId).style.textShadow = "unset";
        } else {
            filterButtons.get(testId).style.color = "#4541DD";
            filterButtons.get(testId).style.textShadow = "0 0 20px #4541DD";
        }
    }

    function highlightLogMessageSearch(testId, messageFilterField) {
        const clearMessageFilterField = document.getElementById(`clear-log-message-search-${testId}`);
        if (messageFilterField.value.length === 0) {
            messageFilterField.style.borderColor = "#D6DDE8";
            messageFilterField.style.borderWidth = "1px";
            clearMessageFilterField.style.display = "none";
        } else {
            messageFilterField.style.borderColor = "#4541DD";
            messageFilterField.style.borderWidth = "2px";
            clearMessageFilterField.style.display = "unset";
        }
    }
</script>

<script type="text/javascript">
    $(document).ready(function () {
        $("#test-overview").treetable({
            expandable: true,
            initialState: "expanded",
            indent: 20,
        });
    });
</script>

<script th:each="test : ${allTests}" th:if="${test.status.name != 'SKIPPED' && !test.traces.isEmpty()}" th:inline="javascript">
    $(document).ready(function () {
        $(`#traces-${$.escapeSelector([[${test.testId}]])}`).treetable({
            expandable: true,
            initialState: "expanded",
            indent: 20,
        });
    });
</script>
</body>
</html>
