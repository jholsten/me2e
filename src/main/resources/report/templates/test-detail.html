<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ME2E Test Results</title>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.5.0/css/all.css">
    <link rel="stylesheet" href="../tree-table/jquery.treetable.css">
    <link rel="stylesheet" href="../css/report-style.css">
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="../tree-table/jquery.treetable.js"></script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        .tag {
            padding: 3px 5px;
            border-radius: 8px;
            border: 2px solid #4541DD;
            font-size: 14px;
            font-weight: 600;
            color: #4541DD;
            background-color: #f7f7ff;
        }

        .container-chip {
            & input {
                appearance: none;
                -webkit-appearance: none;
                -moz-appearance: none;
                margin: 0;
            }

            & input:checked + .label {
                border-color: #4541DD;
                background-color: #4541DD;
                color: white;
                box-shadow: -5px 10px 20px 0 rgba(69, 65, 221, 0.25);
            }

            & .label {
                border-radius: 100px;
                background-color: #fff;
                border: 1px solid #b5b5b5;
                padding: 5px 10px;
                cursor: pointer;
            }
        }

        table {
            & .label {
                font-weight: 600;
                width: 80px;
            }

            & td {
                padding: 5px 0;
            }
        }

        .metadata-table td {
            vertical-align: top;
        }

        .log-table {
            table-layout: fixed;

            & thead {
                position: sticky;
                box-shadow: 0 1px 0 0 #A6A6A6;
            }

            & th {
                text-align: start;
            }

            & td {
                padding: 3px 0;
                vertical-align: top;
            }

            & th:first-child {
                width: 95px;
            }

            & th:nth-child(2) {
                width: 110px;
            }

            & td:first-child {
                width: 97px;
            }

            & td:nth-child(2) {
                width: 112px;
            }

            & tbody {
                display: block;
                overflow-y: auto;
                max-height: 400px;
            }

            & tr {
                display: table;
                width: 100%;
            }
        }

        .stack-trace {
            background-color: rgba(255, 95, 86, 0.05);
            border: 2px solid #FF5F56;
            margin-top: 3px;
        }

        h4 {
            background-color: rgba(129, 169, 231, 0.1);
            color: #618bde;
            padding: 5px 0;
        }
    </style>
</head>
<body>
<div style="display: flex; justify-content: space-between; align-items: center;">
    <h1 th:id="${testId}">Test Summary: [[${displayName}]]</h1>
    <a href="../index.html" style="color: #15134C; text-decoration: none;">
        <i class="fas fa-home fa-lg"></i>
    </a>
</div>
<div style="color: #A6A6A6; margin-bottom: 24px;">
    Source: [[${source}]]
</div>

<div class="card" style="padding: 24px">
    <table class="tree-table test-overview-table" id="test-overview">
        <thead>
        <tr>
            <th class="align-left">Test</th>
            <th>Tests</th>
            <th>Failures</th>
            <th>Skipped</th>
            <th>Duration</th>
            <th>Success Rate</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="test : ${allTests}" th:data-tt-id="${test.testId}" th:data-tt-parent-id="${test.parentId}">
            <td class="align-left">
                <a th:if="${test.children.isEmpty()}"
                   th:style="${'color: ' + (test.status.name == 'SKIPPED' ? '#A6A6A6' : (test.numberOfFailures > 0 ? '#FF5F56' : '#0BBD58'))}"
                   th:href="${'../sources/' + test.source + '.html#' + test.testId}"
                >
                    <span th:text="${test.displayName}"></span>
                </a>
                <span th:if="${!test.children.isEmpty()}">
                    <span th:class="${test.status.name == 'SKIPPED' ? 'skipped' : (test.numberOfFailures > 0 ? 'failure' : 'success')}"
                          th:text="${test.displayName}"
                    ></span>
                </span>
            </td>
            <td th:text="${test.numberOfTests}"></td>
            <td th:text="${test.numberOfFailures}"></td>
            <td th:text="${test.numberOfSkipped}"></td>
            <td th:text="${test.status.name != 'SKIPPED' ? test.duration + 's' : '-'}"></td>
            <td
                    th:classappend="${test.status.name == 'SKIPPED' ? 'skipped' : (test.numberOfFailures > 0 ? 'failure' : 'success')}"
                    th:text="${test.successRate != null ? test.successRate + ' %' : '-'}"
            ></td>
        </tr>
        </tbody>
    </table>
</div>

<h2>Resource Usage</h2>
<div th:if="${!statsByContainer.isEmpty()}">
    <p>
        The following diagrams show the resource usage of the Docker containers during the execution
        of the tests belonging to "[[${displayName}]]".
    </p>
    <div class="card">
        <div>
            Select the container for which you want to display the resource usage.
        </div>
        <div class="container-chip-group" style="padding: 16px 0 48px 0;">
            <span th:each="entry, i : ${statsByContainer}" class="container-chip">
                <label th:for="${entry.key}">
                    <input type="radio" th:id="${entry.key}"
                           th:value="${entry.key}" name="container-chip-group"
                           th:attr="onclick=|onContainerSelected('${entry.key}')|"
                           th:checked="${i.first}">
                    <span th:text="${entry.key}" class="label"></span>
                </label>
            </span>
        </div>
        <div style="text-align: center; margin-bottom: 12px;">
            <b>Resource Usage of Container "<span id="resource-usage-selected-container-name"></span>"</b>
        </div>
        <div style="height: 300px;">
            <div id="resource-usage-chart"></div>
        </div>
    </div>
</div>
<div th:if="${statsByContainer.isEmpty()}">
    <div class="card">
        <div style="height: 200px; display: flex; align-items: center; justify-content: center;">
            <span style="font-size: 20px; margin-right: 12px; color: #A6A6A6;">No Data Available</span>
            <div class="tooltip"><i class="fas fa-circle-info"></i>
                <div class="tooltip-text" style="text-align: start;">
                    There may be several reasons why no data is available:
                    <ul>
                        <li>
                            No containers were started or the started containers were no longer active when this test class was executed.
                        </li>
                        <li>
                            No data was collected during the execution of the tests in this test class. As Docker only sends the data once
                            per second, it is possible that no data was received during the execution.
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<h2>Test Results</h2>
<div th:each="test, iter : ${allTests}" th:if="${test.children.isEmpty()}" th:id="${test.testId}">
    <h3>
        <span th:switch="${test.status.name}">
            <i th:case="'SKIPPED'" class="fas fa-ban skipped"></i>
            <i th:case="'SUCCESSFUL'" class="fas fa-circle-check success"></i>
            <i th:case="'FAILED'" class="fas fa-circle-xmark failure"></i>
            <i th:case="'ABORTED'" class="fas fa-ban aborted"></i>
        </span>
        <span> </span>
        <span th:each="entry, i : ${test.path}">
            <span th:if="${i.first}">
                <a style="color: #15134C;" th:href="${'../sources/' + source + '.html#' + testId}">[[${entry.second}]]</a>
            </span>
            <span th:if="${!i.first}" th:text="${entry.second}"></span>
            <span th:if="${!i.last}"> ></span>
        </span>
    </h3>

    <div class="card">
        <table class="metadata-table">
            <tr th:if="${!test.tags.isEmpty()}">
                <td class="label">Tags:</td>
                <td>
                    <span th:each="tag, i : ${test.tags}">
                        <span class="tag" th:text="${tag}"></span>
                        <span th:if="${!i.last}"> </span>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="label">Status:</td>
                <td th:switch="${test.status.name}">
                    <span th:case="'SKIPPED'" class="skipped"><i class="fas fa-ban"></i> <b>Skipped</b></span>
                    <span th:case="'SUCCESSFUL'" class="success"><i class="fas fa-circle-check"></i> <b>Success</b></span>
                    <span th:case="'FAILED'" class="failure"><i class="fas fa-circle-xmark"></i> <b>Failed</b></span>
                    <span th:case="'ABORTED'" class="aborted"><i class="fas fa-ban"></i> <b>Aborted</b></span>
                </td>
            </tr>
            <tr th:if="${test.status.name == 'SKIPPED' && test.reason != null}">
                <td class="label">Reason:</td>
                <td>
                    <span th:text="${test.reason}"></span>
                </td>
            </tr>
            <tr th:if="${test.status.name != 'SKIPPED'}">
                <td class="label">Started:</td>
                <td th:text="${#temporals.format(test.startTime, 'dd.MM.yyyy HH:mm:ss.SSS')}"></td>
            </tr>
            <tr th:if="${test.status.name != 'SKIPPED'}">
                <td class="label">Finished:</td>
                <td th:text="${#temporals.format(test.endTime, 'dd.MM.yyyy HH:mm:ss.SSS')}"></td>
            </tr>
            <tr th:if="${test.status.name != 'SKIPPED'}">
                <td class="label">Duration:</td>
                <td th:text="${test.duration} + 's'"></td>
            </tr>
            <tr th:if="${test.status.name != 'SKIPPED' && !test.reportEntries.isEmpty()}">
                <td class="label">Report Entries:</td>
                <td>
                    <ul>
                        <li th:each="entry, i : ${test.reportEntries}" th:style="${!i.first ? 'margin-top: 12px;' : ''}">
                            <b>Entry [[${i.index + 1}]]</b> ([[${#temporals.format(entry.timestamp, 'dd.MM.yyyy HH:mm:ss.SSS')}]]):
                            <ul>
                                <li th:each="mapEntry : ${entry.keyValuePairs}">[[${mapEntry.key}]]: [[${mapEntry.value}]]</li>
                            </ul>
                        </li>
                    </ul>
                </td>
            </tr>
        </table>


        <div th:if="${test.status.name != 'SKIPPED'}">
            <div th:if="${test.stackTrace != null}">
                <div style="margin-top: 12px;">
                    <b>Failure:</b>
                </div>
                <div>
                    <pre th:text="${test.stackTrace}" class="stack-trace"></pre>
                </div>
            </div>

            <div>
                <hr class="divider">

                <h4>Network Traces</h4>
                <p>
                    TODO: Traces
                </p>
            </div>

            <div th:if="${!test.logs.isEmpty()}">
                <hr class="divider">

                <h4>Logs</h4>
                <table class="log-table">
                    <thead>
                    <tr>
                        <th>Time</th>
                        <th>Service</th>
                        <th>Message</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="entry : ${test.logs}">
                        <td><code th:text="${#temporals.format(entry.timestamp, 'HH:mm:ss.SSS')}"></code></td>
                        <td>
                            <i class="fas fa-square" style="font-size: 11px;" th:styleappend="${'color: ' + entry.service.color}"></i>
                            <code th:text="${entry.service.name}"></code>
                        </td>
                        <td><code th:text="${entry.message}" style="white-space: pre-wrap"></code></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div th:if="${!iter.last}" style="padding: 16px 0;"></div>
</div>

<div id="footer">
    <span>Generated by <a href="https://gitlab.informatik.uni-bremen.de/master-thesis1/me2e">ME2E</a> at [[${generationTimestamp}]]</span>
</div>

<script type="text/javascript" th:inline="javascript">
    const containerResourceStatistics = /*[[${statsByContainer}]]*/ {};
    let selectedContainerStatistics;

    google.charts.load('current', {'packages': ['line']});
    initializeSelectedContainer();
    google.charts.setOnLoadCallback(drawChart);

    /**
     * Initializes variable [selectedContainerStatistics] based on the [containerResourceStatistics].
     * If [containerResourceStatistics] contains at least one entry, the selected container is
     * set to the first container in the map. Otherwise, the chart is not displayed, since the
     * Thymeleaf condition `${!statsByContainer.isEmpty()}` reolves to `false`.
     */
    function initializeSelectedContainer() {
        if (Object.keys(containerResourceStatistics).length === 0) {
            selectedContainerStatistics = null;
        } else {
            onContainerSelected(Object.keys(containerResourceStatistics)[0]);
        }
    }

    /**
     * Updates the chart data by setting its values to the resource statistics of the [containerName].
     * When this method is called for the first time, the google visualizations package may not be
     * loaded completely. Therefore, exceptions which may occur during drawing the chart, are ignored.
     * As soon as the package is loaded, the [onLoadCallback] calls the function again.
     * @param containerName Name of the container which was selected.
     */
    function onContainerSelected(containerName) {
        document.getElementById('resource-usage-selected-container-name').innerHTML = containerName;
        selectedContainerStatistics = containerResourceStatistics[containerName];
        try {
            drawChart();
        } catch (e) {
        }
    }

    /**
     * Draws line chart for the resource usage statistics of the selected container.
     */
    function drawChart() {
        if (selectedContainerStatistics == null) {
            return;
        }

        const data = new google.visualization.DataTable();
        data.addColumn('datetime', 'Time');
        data.addColumn('number', 'Memory Usage');
        data.addColumn('number', 'CPU Usage');
        data.addColumn('number', 'Network IN');
        data.addColumn('number', 'Network OUT');
        for (const entry of selectedContainerStatistics) {
            data.addRow([
                new Date(Date.parse(entry.timestamp)),
                entry.memoryUsage.percentage,
                entry.cpuUsage.percentage,
                entry.networkUsage.received,
                entry.networkUsage.sent
            ]);
        }

        const options = {
            height: 300,
            series: {
                0: {targetAxisIndex: 0},
                1: {targetAxisIndex: 0},
                2: {targetAxisIndex: 1},
                3: {targetAxisIndex: 1}
            },
            selectionMode: 'multiple',
            hAxis: {
                format: 'HH:mm:ss',
            },
            vAxes: {
                0: {
                    title: 'Percentage',
                    format: "#.##' %'",
                    viewWindow: {
                        min: 0,
                    },
                },
                1: {
                    title: 'Number of Bytes',
                    viewWindow: {
                        min: 0,
                    },
                },
            },
        };

        const chart = new google.charts.Line(document.getElementById('resource-usage-chart'));
        chart.draw(data, google.charts.Line.convertOptions(options));
    }
</script>

<script type="text/javascript">
    $(document).ready(function () {
        $("#test-overview").treetable({
            expandable: true,
            initialState: "expanded",
            indent: 20,
        });
    });
</script>
</body>
</html>
